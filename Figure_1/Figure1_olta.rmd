---
title: "Assignment 1"
author: "Olta"
date: "2026-01-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries}
# Load packages used in class for vector and raster spatial analysis
# sf: vector data (districts, dams)
# terra: raster data (elevation)
# tidyverse: data handling and plotting
library(sf)
library(terra)
library(tidyverse)
```

### Load data
```{r load_data}
# ------------------------------------------------------
# Load spatial data
# ------------------------------------------------------

# Administrative districts of South Africa (level 2)
# These units match the spatial aggregation used in the paper
sa_districts <- st_read("boundaries/gadm41_ZAF_2.shp")

# Global Reservoir and Dam (GRanD) database
# Provides point locations of large dams worldwide
dams <- st_read("dams/GRanD_dams_v1_3.shp")

# Elevation raster (SRTM-based)
# Used as a proxy for river gradient at the district level
elev <- rast("elevation/wc2.1_30s_elev.tif")
```

### Filter dams
```{r filter_dams}
# ------------------------------------------------------
# Restrict dams to South Africa
# ------------------------------------------------------

# Spatial intersection keeps only dam points located
# within South African district boundaries
dams_sa <- dams[sa_districts, ]
```

### CRS harmonisation
```{r transform_crs}
# ------------------------------------------------------
# Harmonise coordinate reference systems
# ------------------------------------------------------

# All spatial objects are transformed to WGS84 (EPSG:4326).
# Although the original datasets already use this CRS,
# this step ensures consistency and mirrors the class workflow.
sa_districts <- st_transform(sa_districts, 4326)
dams_sa <- st_transform(dams_sa, 4326)
elev <- project(elev, "EPSG:4326")
```

### Crop and mask raster
```{r crop_elevation}
# ------------------------------------------------------
# Crop elevation raster to South Africa
# ------------------------------------------------------

# Convert district polygons to terra vector format
sa_vect <- vect(sa_districts)

# Crop and mask reduce the raster to the study area,
# improving performance and ensuring correct aggregation
elev_sa <- crop(elev, sa_vect)
elev_sa <- mask(elev_sa, sa_vect)
```

### Aggregate elevation (this is key)
```{r aggregate_elevation}
# ------------------------------------------------------
# Aggregate elevation by district
# ------------------------------------------------------

# Mean elevation is computed for each district polygon
# This serves as a proxy for average river gradient,
# which is not directly available at the district level
elev_mean <- terra::extract(
  elev_sa,
  sa_vect,
  fun = mean,
  na.rm = TRUE
)

# Attach aggregated values to district data
sa_districts$mean_elev <- elev_mean[, 2]
```


### Create classes
```{r create_bins}
# ------------------------------------------------------
# Create discrete elevation classes
# ------------------------------------------------------

# Quantile-based bins are used to reproduce the
# discrete shading scheme of the original figure
breaks <- quantile(
  sa_districts$mean_elev,
  probs = seq(0, 1, length.out = 7),
  na.rm = TRUE
)

labels <- paste0(
  round(breaks[-length(breaks)]), "â€“", round(breaks[-1])
)

sa_districts$elev_class <- cut(
  sa_districts$mean_elev,
  breaks = breaks,
  labels = labels,
  include.lowest = TRUE
)
```

### Replication of Figure 2: Dam locations and average elevation by district
```{r final_map, eval=TRUE}
# ------------------------------------------------------
# Replication map
# ------------------------------------------------------

p <- ggplot() +
  geom_sf(data = sa_districts, aes(fill = elev_class),
          color = "white", linewidth = 0.15) +
  geom_sf(data = dams_sa, color = "black", size = 0.3, alpha = 0.6) +
  scale_fill_grey(start = 0.9, end = 0.2,
                  name = "Average elevation\n(proxy for river gradient)") +
  labs(
    title = "Dam locations and average elevation by district"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

ggsave(
  "figure2_dams_elevation.png",
  plot = p,
  width = 14,
  height = 8,
  dpi = 300
)
```

## Explanation section

```markdown
## Data choices and proxy justification

The original figure reports average river gradient by district, a variable that is not
directly available at the administrative district level for South Africa. To reproduce
the qualitative spatial patterns shown in the paper, I use mean elevation aggregated at
the district level as a proxy. Elevation captures broad variation in terrain steepness
and is correlated with river gradients at an aggregate spatial scale.

Elevation values are derived from SRTM-based raster data and aggregated using district
polygons. Districts are grouped into quantile-based classes to match the discrete
shading used in the original figure rather than a continuous color scale. Dam locations
are taken from the GRanD database and restricted to South Africa using spatial
intersection.

This approach reproduces the main qualitative features of the original map, including
the concentration of dams in higher-elevation eastern regions. While elevation is an
imperfect substitute for river gradient, it provides a transparent and replicable proxy
given data availability constraints.
```
